(window.webpackJsonp=window.webpackJsonp||[]).push([[120],{924:function(t,a,s){"use strict";s.r(a);var e=s(17),r=Object(e.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"カスタム連携のために-btcpay-api-を使う"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#カスタム連携のために-btcpay-api-を使う"}},[t._v("#")]),t._v(" カスタム連携のために BTCPay API を使う")]),t._v(" "),a("p",[t._v("BTCPay Server は、連携のために 2 つの API を提供しています。")]),t._v(" "),a("ul",[a("li",[a("RouterLink",{attrs:{to:"/Development/GreenFieldExample/"}},[t._v("GreenField API")]),t._v(" - BTCPay Server をヘッドレスで利用できることを目的とした RESTful API です。Bitpay 連携のコードを流用しないプロジェクトには、こちらの API を推奨します。")],1),t._v(" "),a("li",[t._v("Bitpay Invoice API - BTCPay は、請求書の作成・管理について Bitpay と同じ API を実装しています。")])]),t._v(" "),a("p",[a("strong",[t._v("BitPay から BTCPay への移行")]),t._v("は、通常 URL を変更するだけで済みます。")]),t._v(" "),a("p",[t._v("Bitpay が 1 商人につき 1 アカウントのみ許可しているのに対し、BTCPay では 1 人のユーザーが複数ストアを管理できます。")]),t._v(" "),a("h2",{attrs:{id:"公式クライアントライブラリ"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#公式クライアントライブラリ"}},[t._v("#")]),t._v(" 公式クライアントライブラリ")]),t._v(" "),a("p",[t._v("BTCPay は "),a("a",{attrs:{href:"https://github.com/MetacoSA/NBitpayClient",target:"_blank",rel:"noopener noreferrer"}},[t._v("C#"),a("OutboundLink")],1),t._v("、"),a("a",{attrs:{href:"https://github.com/btcpayserver/btcpay-python",target:"_blank",rel:"noopener noreferrer"}},[t._v("Python"),a("OutboundLink")],1),t._v("、"),a("a",{attrs:{href:"https://github.com/btcpayserver/node-btcpay",target:"_blank",rel:"noopener noreferrer"}},[t._v("NodeJS"),a("OutboundLink")],1),t._v(" の公式クライアントライブラリを提供しています。")]),t._v(" "),a("p",[t._v("さらに、Bitpay クライアントの "),a("a",{attrs:{href:"https://github.com/btcpayserver/btcpayserver-php-client",target:"_blank",rel:"noopener noreferrer"}},[t._v("PHP"),a("OutboundLink")],1),t._v(" および "),a("a",{attrs:{href:"https://github.com/bitpay/ruby-client",target:"_blank",rel:"noopener noreferrer"}},[t._v("Ruby"),a("OutboundLink")],1),t._v(" のフォークリポジトリもあります。")]),t._v(" "),a("h2",{attrs:{id:"api-へ手動でアクセスする"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#api-へ手動でアクセスする"}},[t._v("#")]),t._v(" API へ手動でアクセスする")]),t._v(" "),a("p",[t._v("上記ライブラリを使わない場合、REST API には手動でアクセスできます。")]),t._v(" "),a("p",[t._v("認証メカニズムには "),a("code",[t._v("BitId")]),t._v(" を使用します。")]),t._v(" "),a("p",[a("code",[t._v("BitId")]),t._v(" では、API の "),a("code",[t._v("client")]),t._v("（e コマースプラグインなど）が秘密鍵を生成し、"),a("code",[t._v("server")]),t._v("（BTCPay）に公開鍵を通知します。")]),t._v(" "),a("p",[t._v("クライアントから API に送るすべてのリクエストは、クライアントの "),a("code",[t._v("private key")]),t._v(" で署名されます。")]),t._v(" "),a("p",[t._v("BTCPay に "),a("code",[t._v("public key")]),t._v(" を通知するプロセスを "),a("code",[t._v("pairing")]),t._v(" と呼びます。")]),t._v(" "),a("h2",{attrs:{id:"ペアリングプロセス"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ペアリングプロセス"}},[t._v("#")]),t._v(" ペアリングプロセス")]),t._v(" "),a("p",[t._v("まず新しいストアを作成する必要があります。")]),t._v(" "),a("ol",[a("li",[t._v("ログイン")]),t._v(" "),a("li",[t._v("Stores メニューへ移動")]),t._v(" "),a("li",[a("code",[t._v("Create a new store")]),t._v(" をクリック")]),t._v(" "),a("li",[t._v("ストアの表示名を入力して確定")])]),t._v(" "),a("p",[a("code",[t._v("pairing")]),t._v(" には、クライアント側ペアリングとサーバー側ペアリングの 2 つの方法があります。")]),t._v(" "),a("h3",{attrs:{id:"クライアント側ペアリング"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#クライアント側ペアリング"}},[t._v("#")]),t._v(" クライアント側ペアリング")]),t._v(" "),a("p",[t._v("クライアント側ペアリングでは、"),a("code",[t._v("client")]),t._v(" が自身の "),a("code",[t._v("public key")]),t._v(" から URL を生成し、利用者がその URL を開いてペアリングを承認します。")]),t._v(" "),a("p",[t._v("通常、URL は "),a("code",[t._v("https://btcpay.example.com/api-access-request?pairingCode=<pairingcode_goes_here>")]),t._v(" のような形式です。")]),t._v(" "),a("p",[t._v("この方法の実装方法は "),a("a",{attrs:{href:"https://support.bitpay.com/hc/en-us/articles/115003001183-How-do-I-pair-my-client-and-create-a-token-",target:"_blank",rel:"noopener noreferrer"}},[t._v("こちらのリンク"),a("OutboundLink")],1),t._v(" を参照してください。")]),t._v(" "),a("h3",{attrs:{id:"サーバー側ペアリング"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#サーバー側ペアリング"}},[t._v("#")]),t._v(" サーバー側ペアリング")]),t._v(" "),a("p",[t._v("もう一つの方法は、何らかの bitcoin ライブラリで秘密鍵を生成したうえで、次を行うことです。")]),t._v(" "),a("ol",[a("li",[t._v("ストア設定へ移動")]),t._v(" "),a("li",[a("code",[t._v("Access tokens")]),t._v(" をクリック")]),t._v(" "),a("li",[a("code",[t._v("Create new Token")]),t._v(" をクリック")]),t._v(" "),a("li",[t._v("merchant facade を選択して公開鍵を入力")]),t._v(" "),a("li",[t._v("request pairing をクリック")]),t._v(" "),a("li",[t._v("Approve をクリック")])]),t._v(" "),a("h2",{attrs:{id:"注記"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注記"}},[t._v("#")]),t._v(" 注記")]),t._v(" "),a("p",[a("strong",[t._v("BTCPay Server は Bitpay 互換の API を備えている")]),t._v("ため、e コマースアプリケーションを "),a("strong",[t._v("Bitpay から BTCPay に切り替える")]),t._v("作業は最小限で済みます。")]),t._v(" "),a("p",[t._v("完全な API ドキュメントは "),a("a",{attrs:{href:"https://bitpay.com/api#resource-Invoices",target:"_blank",rel:"noopener noreferrer"}},[t._v("Bitpay のウェブサイト"),a("OutboundLink")],1),t._v(" で確認できます。")]),t._v(" "),a("p",[t._v("違いは 1 点だけです。Bitpay は 1 商人につき 1 アカウントのみ許可しますが、BTCPay は 1 人のユーザーが複数ストアを管理できます。")]),t._v(" "),a("h2",{attrs:{id:"モーダルチェックアウト"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#モーダルチェックアウト"}},[t._v("#")]),t._v(" モーダルチェックアウト")]),t._v(" "),a("p",[t._v("ポップアップモーダルの体験を生成するには次を実行します。")]),t._v(" "),a("ol",[a("li",[t._v("HTML ページに btcpay.js スクリプトを含める")])]),t._v(" "),a("div",{staticClass:"language-html extra-class"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("src")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("https://your.btcpay.url/modal/btcpay.js"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token script"}}),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[t._v("Invoice API を呼び出して請求書を生成する（コード例）。これは認証トークンを含むため、フロントエンドへ公開すべきでないバックエンドのサンプルコードです。")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" axiosClient "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" axios"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("create")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("baseURL")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("BTCPAY_URL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("timeout")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("responseType")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'json'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("headers")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v("'Content-Type'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'application/json'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("Authorization")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("BTCPAY_AUTH")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" invoiceCreation "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("price")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12345")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("currency")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'USD'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("orderId")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'something'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("itemDesc")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'item description'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("notificationUrl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://webhook.after.checkout.com/goeshere'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("redirectURL")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://go.here.after.checkout.com'")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" response "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" axiosClient"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("post")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/invoices'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" invoiceCreation"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" invoiceId "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id\n")])])]),a("ol",{attrs:{start:"3"}},[a("li",[t._v("invoiceId を使ってモーダルを表示する")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("btcpay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("showInvoice")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("invoiceId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("ol",{attrs:{start:"4"}},[a("li",[t._v("請求書が支払われたときにページ状態を更新したり、モーダル表示前後で何らかの状態を記録したりしたい場面はよくあります。次のようにイベントリスナーを追加できます。")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("btcpay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("onModalWillEnter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("yourCallbackFunction"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nwindow"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("btcpay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("onModalWillLeave")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("yourCallbackFunction"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nwindow"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("btcpay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("onModalReceiveMessage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("yourCallbackFunction"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// available from v1.0.5.6")]),t._v("\n")])])]),a("p",[a("code",[t._v("onModalReceiveMessage")]),t._v(" は、請求書 UI に新しいステータスが BTCPay Server から push されたときにコールバックを呼び出します。データ形式は "),a("code",[t._v('{invoiceId: "x", status: "y" }')]),t._v(" です。")])])}),[],!1,null,null,null);a.default=r.exports}}]);