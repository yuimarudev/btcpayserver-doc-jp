(window.webpackJsonp=window.webpackJsonp||[]).push([[129],{943:function(s,a,t){"use strict";t.r(a);var e=t(17),r=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"reverse-ssh-トンネルでポートを転送する"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#reverse-ssh-トンネルでポートを転送する"}},[s._v("#")]),s._v(" reverse SSH トンネルでポートを転送する")]),s._v(" "),a("h2",{attrs:{id:"利点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#利点"}},[s._v("#")]),s._v(" 利点")]),s._v(" "),a("ul",[a("li",[s._v("ホスト側 LAN でポートフォワーディングが不要")]),s._v(" "),a("li",[s._v("接続が暗号化される")]),s._v(" "),a("li",[s._v("ホストの IP を隠せる")])]),s._v(" "),a("h2",{attrs:{id:"要件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#要件"}},[s._v("#")]),s._v(" 要件")]),s._v(" "),a("ul",[a("li",[s._v("Virtual Private Server (VPS)（例: Lunanode の最小プランで約 3.5$/月）")]),s._v(" "),a("li",[s._v("VPS で root アクセス可能であること（1000 未満のポート転送は root のみ可能）")]),s._v(" "),a("li",[s._v("ホストコンピューター（ポート転送元）への ssh アクセス")])]),s._v(" "),a("h2",{attrs:{id:"セットアップ"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#セットアップ"}},[s._v("#")]),s._v(" セットアップ")]),s._v(" "),a("h3",{attrs:{id:"ホスト側（btcpay-server-インスタンス）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ホスト側（btcpay-server-インスタンス）"}},[s._v("#")]),s._v(" ホスト側（BTCPay Server インスタンス）")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# switch to root user (if not logged in as root)")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" -\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# check for an existing ssh public key")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" ~/.ssh/*.pub\n")])])]),a("p",[s._v("公開鍵がなければ生成します（ENTER を押し続けます）。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("ssh-keygen "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" rsa "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-b")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v("\n")])])]),a("p",[s._v("これにより "),a("code",[s._v("~/.ssh")]),s._v(" 内に SSH キーペア "),a("code",[s._v("id_rsa")]),s._v("（秘密鍵）と "),a("code",[s._v("id_rsa.pub")]),s._v("（公開鍵）が生成されます。")]),s._v(" "),a("p",[s._v("秘密鍵は ssh-agent に追加する必要があります。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# start the ssh-agent in the background")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("eval")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("ssh-agent "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add private key to ssh-agent")]),s._v("\nssh-add ~/.ssh/id_rsa\n")])])]),a("p",[s._v("公開鍵を VPS にコピーします（"),a("code",[s._v("VPS_IP_ADDRESS")]),s._v(" を入力）。\nVPS の root パスワード入力が求められます。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("ssh-copy-id "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" ~/.ssh/id_rsa.pub root@VPS_IP_ADDRESS\n")])])]),a("p",[s._v("動作確認として VPS に SSH 接続します。成功すればパスワードはもう求められません。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" root@VPS_IP_ADDRESS\n")])])]),a("h3",{attrs:{id:"vps-側"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#vps-側"}},[s._v("#")]),s._v(" VPS 側")]),s._v(" "),a("p",[s._v("先ほどの接続を再利用しても、root で再ログインしても構いません。")]),s._v(" "),a("p",[s._v("sshd 設定を編集します。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nano")]),s._v(" /etc/ssh/sshd_config\n")])])]),a("p",[s._v("次の項目が有効になっていることを確認してください（行頭に "),a("code",[s._v("#")]),s._v(" がない状態）。\nまたは、以下をファイル末尾に貼り付けても構いません。")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("RSAAuthentication yes     # not needed on latest OpenSSH versions\nPubkeyAuthentication yes\nGatewayPorts yes\nAllowTcpForwarding yes\nClientAliveInterval 60\n")])])]),a("p",[s._v("保存は CTRL+O, ENTER、終了は CTRL+X です。")]),s._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[s._v("WARNING")]),s._v(" "),a("p",[s._v("この時点で sshd 設定が誤っているとアクセス不能になる可能性があります。必ず再確認してください。")])]),s._v(" "),a("p",[s._v("sshd サービスを再起動します。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl restart sshd\n")])])]),a("h3",{attrs:{id:"ホスト側（btcpay-server-インスタンス）に戻る"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ホスト側（btcpay-server-インスタンス）に戻る"}},[s._v("#")]),s._v(" ホスト側（BTCPay Server インスタンス）に戻る")]),s._v(" "),a("h4",{attrs:{id:"autossh-のインストールと設定"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#autossh-のインストールと設定"}},[s._v("#")]),s._v(" autossh のインストールと設定")]),s._v(" "),a("p",[s._v("依存パッケージ "),a("code",[s._v("autossh")]),s._v(" をインストールします。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" autossh\n")])])]),a("p",[s._v("サービスファイルを作成します。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nano")]),s._v(" /etc/systemd/system/autossh-tunnel.service\n")])])]),a("p",[s._v("以下を貼り付け、"),a("code",[s._v("VPS_IP_ADDRESS")]),s._v(" を入力します。\n必要に応じてポートを追加・削除してください。")]),s._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token section"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("Unit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Description")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("AutoSSH tunnel service")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("After")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("network.target")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token section"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("Service")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("User")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("root")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("root")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token inner-value"}},[s._v("AUTOSSH_GATETIME=0")]),s._v('"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v('/usr/bin/autossh -C -M 0 -v -N -o "ServerAliveInterval=60" -R 9735:localhost:9735 -R 443:localhost:443 -R 80:localhost:80 root@VPS_IP_ADDRESS')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("StandardOutput")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("journal")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token section"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("Install")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("WantedBy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("multi-user.target")]),s._v("\n")])])]),a("p",[s._v("サービスを有効化して起動します。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" autossh-tunnel\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl start autossh-tunnel\n")])])]),a("p",[s._v("これで reverse ssh-tunnel によるポート転送は完了です。\nVPS の IP 経由でホストコンピューターのポート/サービスにアクセスできるはずです。")]),s._v(" "),a("h2",{attrs:{id:"監視"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#監視"}},[s._v("#")]),s._v(" 監視")]),s._v(" "),a("p",[s._v("ホストコンピューターでエラーがないか確認します。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" journalctl "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-u")]),s._v(" autossh-tunnel\n")])])]),a("p",[s._v("VPS 側でトンネルが有効か確認するには:")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("netstat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-tulpn")]),s._v("\n")])])]),a("h2",{attrs:{id:"参考資料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考資料"}},[s._v("#")]),s._v(" 参考資料")]),s._v(" "),a("ul",[a("li",[s._v("Raspiblitz FAQ: "),a("a",{attrs:{href:"https://github.com/rootzoll/raspiblitz/blob/master/FAQ.md#how-to-setup-port-forwarding-with-a-ssh-tunnel",target:"_blank",rel:"noopener noreferrer"}},[s._v("How to setup port-forwarding with a SSH tunnel?"),a("OutboundLink")],1)]),s._v(" "),a("li",[s._v("RaspiBolt Docs: "),a("a",{attrs:{href:"https://raspibolt.org/guide/raspberry-pi/security.html#login-with-ssh-keys",target:"_blank",rel:"noopener noreferrer"}},[s._v("Login with SSH keys"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=r.exports}}]);